import{IndexedDBWrapper}from"./indexedDB/IndexedDBWrapper.js";import{MediaItem,MEDIA_TYPE}from"./components/MediaItem.js";import{PAGES}from"./components/LogItem.js";import{Router}from"./utils/Router.js";const collapse=document.getElementById("collapse"),imageBox=document.getElementById("image-collection"),videoBox=document.getElementById("video-collection"),gallery=document.getElementById("media-gallery"),addBtn=document.querySelector(".addBtn"),imageButton=document.getElementById("add-image-btn"),videoButton=document.getElementById("add-video-btn"),addTaskBtn=document.getElementById("addTaskBtn");function addTask(e){if(null===e||""===e)return;new IndexedDBWrapper("experimentalDB",1).transaction((t=>{t.target.result.transaction(["currentLogStore"],"readwrite").objectStore("currentLogStore").openCursor().onsuccess=function(t){const n=t.target.result;if(n){const t=(new Router).url,o=n.value,d=t.searchParams.get("name").replace(/\+/g," "),a=o.properties.collections.find((e=>d===e.name)).tasks,i={description:e,logType:"task",finished:!1};a.push(i),n.update(o)}}}))}function newElement(){const e=document.getElementById("myInput").value;if(0===e.length)return void alert("You must write something!");const t=document.createElement("li"),n=document.createElement("log-item");n.finished=!1;const o={logType:"task"};o.description=e,t.appendChild(n),n.itemEntry=o,n.setHoverListeners(),document.getElementById("myUL").appendChild(t),document.getElementById("myInput").value=""}function populateTasks(e){const t=e.tasks,n=document.getElementById("myUL");t.forEach(((e,t)=>{const o=function(e){const t=document.createElement("log-item");return t.itemEntry=e,t.page=PAGES["collection-edit"],t}(e),d=document.createElement("li");d.appendChild(o),n.appendChild(d),o.setHoverListeners()}))}function populateCollectionName(){const e=(new Router).url.searchParams.get("name").replace(/\+/g," ");return document.querySelector("#title > h1").textContent=e,e}function populateMedia(e,t=MEDIA_TYPE.IMAGE,n){let o,d,a,i;t===MEDIA_TYPE.IMAGE?(o=e.images,a=document.getElementById("add-image-btn"),d=document.getElementById("image-collection")):(i="video",o=e.videos,a=document.getElementById("add-video-btn"),d=document.getElementById("video-collection")),o.forEach(((e,i)=>{const l=function(e){const n=document.createElement("media-item");return n.file=e.file,n.media=t,n}(e),r=l.shadowRoot.querySelector("video");n&&i===o.length-1&&(console.log(i),r.addEventListener("canplaythrough",(()=>{document.getElementById("loading").style.display="none"}))),d.insertBefore(l,a)}))}function getLogInfoAsJSON(e){new IndexedDBWrapper("experimentalDB",1).transaction((t=>{t.target.result.transaction(["currentLogStore"],"readonly").objectStore("currentLogStore").openCursor().onsuccess=function(t){const n=t.target.result;if(n){const t=(new Router).url.searchParams.get("name").replace(/\+/g," "),o=n.value.properties.collections.find((e=>e.name===t));console.log(o),e.bind(this),e(o)}}}))}function updateLogInfo(e,t){new IndexedDBWrapper("experimentalDB",1).transaction((n=>{n.target.result.transaction(["currentLogStore"],"readwrite").objectStore("currentLogStore").openCursor().onsuccess=function(n){const o=n.target.result;if(o){const n=e;let d=o.value.properties.collections.find((e=>e.name===n));d=t(d),o.update(o.value)}}}))}function insertMedia(e,t,n=MEDIA_TYPE.IMAGE){const o=t.target.files[0],d=document.createElement("media-item");if(d.file=o,d.media=n,updateLogInfo(e,(e=>((n===MEDIA_TYPE.IMAGE?e.images:e.videos).push({type:"string",file:o}),console.log(`pushed to ${n===MEDIA_TYPE.IMAGE?"images":"videos"}!`),e))),n===MEDIA_TYPE.IMAGE){const e=document.getElementById("add-image-btn");imageBox.insertBefore(d,e)}else{const e=document.getElementById("add-video-btn");document.getElementById("video-collection").appendChild(d),videoBox.insertBefore(d,e)}}function populatePage(e){e&&(populateTasks(e),populateMedia(e,MEDIA_TYPE.IMAGE,!1),0!==e.videos.length?populateMedia(e,MEDIA_TYPE.VIDEO,!0):document.getElementById("loading").style.display="none")}addTaskBtn.addEventListener("click",(()=>{addTask(document.getElementById("myInput").value)})),collapse.addEventListener("click",(()=>{'<i class="fa fa-chevron-up fa-2x"></i>'===collapse.innerHTML?(gallery.style.display="none",collapse.innerHTML='<i class="fa fa-chevron-down fa-2x"></i>'):(gallery.style.display="flex",collapse.innerHTML='<i class="fa fa-chevron-up fa-2x"></i>')})),addBtn.addEventListener("click",(()=>{newElement()})),document.addEventListener("DOMContentLoaded",(e=>{console.log("dom content loaded"),console.time();const t=populateCollectionName();getLogInfoAsJSON(populatePage),console.timeEnd(),imageButton.addEventListener("input",(e=>{insertMedia.bind(e),insertMedia(t,e,MEDIA_TYPE.IMAGE)})),videoButton.addEventListener("input",(e=>{insertMedia.bind(e),insertMedia(t,e,MEDIA_TYPE.VIDEO)}))}));