import{wrapper}from"./components/CollectionItem.js";import{IndexedDBWrapper}from"./indexedDB/IndexedDBWrapper.js";import{DateConverter}from"./utils/DateConverter.js";import{Router,ROUTES}from"./utils/Router.js";import{Tag}from"./components/tag.js";const collapse=document.getElementById("collapse"),quote=document.getElementById("reflection"),text=document.getElementById("input-area"),date=document.getElementById("date-input"),time=document.getElementById("time-input"),saveBtn=document.getElementById("cb2"),cancelBtn=document.getElementById("cb1"),refRadio=document.getElementById("input1"),eventRadio=document.getElementById("input2"),taskRadio=document.getElementById("input3"),noteRadio=document.getElementById("input4"),radioContainer=document.getElementsByClassName("container")[0],tmButton=document.getElementById("tomorrow"),ytButton=document.getElementById("yesterday"),tagOptions=document.querySelector(".tag-options");function setPlaceholder(){let e;e=refRadio.checked?"Input your reflection here":eventRadio.checked?"Input your event here":taskRadio.checked?"Input your task here":"Input your note here",text.setAttribute("placeholder",e)}function addCollectionTag(e){wrapper.transaction((t=>{t.target.result.transaction(["currentLogStore"],"readwrite").objectStore("currentLogStore").openCursor().onsuccess=function(t){const n=t.target.result;if(n){const t=n.value,o=t.properties.collections,a=(new Router).url.searchParams,i=Number(a.get("timestamp"));o.forEach((t=>{t.name===e&&t.logs.push(i)})),n.update(t)}}}));document.querySelector(".tag-options").childNodes.forEach((t=>{t.textContent===e&&t.remove()}))}function newElement(){const e=document.getElementById("input-area").value;if(0===e.length)return void alert("You must write something!");const t=document.createElement("li"),n=document.createElement("log-item"),o={};let a="";if(taskRadio.checked)o.logType="task",o.finished=!1,a="tasks";else if(noteRadio.checked)o.logType="note",a="notes";else if(eventRadio.checked){o.logType="event",a="events";const e=Number(time.value.substring(0,2)),t=Number(time.value.substring(3)),n=Date.parse(date.value)+60*e*60*1e3+60*t*1e3+60*(new Date).getTimezoneOffset()*1e3;o.time=n}else o.logType="reflection",a="reflection";o.description=e,n.itemEntry=o,t.appendChild(n),n.setHoverListeners(),document.getElementById("myUL").appendChild(t),document.getElementById("input-area").value="",updateElement(o,a)}function resetEverything(){date.style.visibility="hidden",date.value="",text.value="",text.style.visibility="hidden",saveBtn.style.display="none",cancelBtn.style.display="none",time.value="",time.style.visibility="hidden"}function updateElement(e,t){new IndexedDBWrapper("experimentalDB",1).transaction((n=>{n.target.result.transaction(["currentLogStore"],"readwrite").objectStore("currentLogStore").openCursor().onsuccess=function(n){const o=n.target.result;if(o){const n=(new Router).url.searchParams;if(n.has("timestamp")){const a=Number(n.get("timestamp")),i=new DateConverter(a);o.value.$defs["daily-logs"].forEach(((n,a)=>{i.equals(Number(n.properties.date.time))&&o.value.$defs["daily-logs"][a].properties[t].push(e)}))}o.update(o.value)}}}))}function getLogInfoAsJSON(e,t){new IndexedDBWrapper("experimentalDB",1).transaction((n=>{n.target.result.transaction(["currentLogStore"],"readwrite").objectStore("currentLogStore").openCursor().onsuccess=async function(n){const o=n.target.result;if(o){const n=(new Router).url.searchParams;if(n.has("timestamp")){const a=Number(n.get("timestamp")),i=new DateConverter(a);let s=!1;if(o.value.$defs["daily-logs"].forEach(((t,n)=>{i.equals(Number(t.properties.date.time))&&(s=!0,e.bind(this),e(o.value.$defs["daily-logs"][n],o.value))})),!s){o.value.$defs["daily-logs"];const n={type:"object",required:["date","description"],properties:{date:{type:"string",time:a,description:"The date of the event."},events:[],tasks:[],notes:[],reflection:[{description:t,logType:"reflection"}],mood:{type:"number",multipleOf:1,minimum:0,exclusiveMaximum:100,value:50,description:"Daily mood on a range of 0-99."}}};o.value.$defs["daily-logs"].push(n),o.update(o.value),e.bind(this),e(n,o.value)}}}}}))}function setEntries(e){function t(e){e.forEach(((e,t)=>{const n=document.createElement("li"),o=document.createElement("log-item");e.editable=!0,o.itemEntry=e,n.appendChild(o),o.setHoverListeners(),document.getElementById("myUL").appendChild(n)}))}t(e.properties.reflection),t(e.properties.events),t(e.properties.tasks),t(e.properties.notes)}function setReflection(e){const t=e.properties.mood;document.querySelector("reflection-item").entry=t}function setDate(e){const t=getDateFromUNIXTimestamp(Number(e.properties.date.time));document.querySelector("#title > .date").innerText=t.toLocaleDateString()}function setTags(e){const t=e.properties.collections,n=(new Router).url.searchParams,o=new DateConverter(Number(n.get("timestamp")));o.timestamp;t.forEach((e=>{(e=>!(void 0===e.find((e=>o.equals(new DateConverter(e))))))(e.logs)&&document.querySelector(".tags").append(new Tag(e.name))}))}function setTagOptions(e){const t=e.properties.collections,n=(new Router).url.searchParams,o=new DateConverter(Number(n.get("timestamp"))),a=(o.timestamp,document.querySelector(".tag-options"));a.innerHTML="";t.forEach((e=>{if(!(e=>!(void 0===e.find((e=>o.equals(new DateConverter(e))))))(e.logs)){const t=document.createElement("a");t.setAttribute("href","#"),t.textContent=e.name,a.append(t)}}))}function populateDailyLog(e,t){e&&(setDate(e),setEntries(e),setReflection(e)),setTags(t),setTagOptions(t)}function getDateFromUNIXTimestamp(e){return new DateConverter(e)}function showTextInput(){text.style.visibility="visible",saveBtn.style.display="inline-block",cancelBtn.style.display="inline-block"}cancelBtn.addEventListener("click",(()=>{resetEverything()})),radioContainer.addEventListener("change",(()=>{resetEverything(),refRadio.checked||noteRadio.checked?showTextInput():eventRadio.checked?(time.style.visibility="visible",time.style.display="inline-block"):taskRadio.checked&&(date.style.visibility="visible",time.style.display="none"),setPlaceholder()})),tagOptions.addEventListener("click",(e=>{const t=e.target.textContent;document.querySelector(".tags").append(new Tag(t)),addCollectionTag(t)})),document.addEventListener("DOMContentLoaded",(e=>{saveBtn.style.display="none",cancelBtn.style.display="none",saveBtn.addEventListener("click",(e=>{e.preventDefault(),newElement()})),collapse.addEventListener("click",(()=>{if(""===quote.style.display||"none"===quote.style.display){collapse.removeChild(collapse.childNodes[1]);const e=document.createElement("i");e.className="fa fa-chevron-up fa-lg",collapse.appendChild(e),quote.style.display="block"}else{collapse.removeChild(collapse.childNodes[1]);const e=document.createElement("i");e.className="fa fa-chevron-down fa-lg",collapse.appendChild(e),quote.style.display="none"}})),date.addEventListener("change",(()=>{showTextInput()})),time.addEventListener("change",(()=>{date.style.visibility="visible"})),fetch("https://api.quotable.io/random").then((e=>e.json())).then((e=>`${e.content} â€”${e.author}`)).then((e=>{getLogInfoAsJSON(populateDailyLog,e)}))}));const yesterdayTodayNav=(e=!0)=>{const t=new Router,n=t.url.searchParams;if(n.has("timestamp")){const o=Number(n.get("timestamp"));n.set("timestamp",e?o-864e5:o+864e5),t.navigate()}};tmButton.addEventListener("click",(()=>{yesterdayTodayNav(!1)})),ytButton.addEventListener("click",(()=>{yesterdayTodayNav(!0)}));